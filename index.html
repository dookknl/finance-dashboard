// ... (All your helper functions and rendering logic remain the same)

// ===================== INIT =====================
window.addEventListener('load', () => {
  applyStoredTheme();
  
  // 1. Get stored preferences or set defaults
  const storedPerson = localStorage.getItem('targetPerson');
  if (storedPerson && PEOPLE_IDS.includes(storedPerson)) {
    TARGET_PERSON = storedPerson;
  } else {
    localStorage.setItem('targetPerson', TARGET_PERSON);
  }
  
  const storedLang = localStorage.getItem('dashboardLang');
  if (storedLang && TRANSLATIONS.hasOwnProperty(storedLang)) {
    CURRENT_LANG = storedLang;
    $('#lang-select').value = storedLang;
  } else {
    localStorage.setItem('dashboardLang', CURRENT_LANG);
  }

  // 2. Populate the person selector with initial data
  populatePersonSelector(); 

  // 3. Set up event listeners
  $('#toggleTheme').addEventListener('click', toggleTheme);
  $('#fullscreen-button').addEventListener('click', enterFullscreen);
  $('#person-select').addEventListener('change', (e) => setPerson(e.target.value));
  $('#lang-select').addEventListener('change', (e) => setLanguage(e.target.value));
  $('#toggle-auto').addEventListener('click', toggleSwitcher);

  // 4. Initial data load and translation application
  // applyTranslations calls fetchDashboardData which does the first render.
  applyTranslations(CURRENT_LANG); 

  // 5. Start auto-switch if enabled
  const autoSwitchEnabled = localStorage.getItem('autoSwitchEnabled');
  if (autoSwitchEnabled === 'true' && !switcherInterval) {
    const button = $('#toggle-auto');
    switcherInterval = setInterval(() => {
        const currentIndex = PEOPLE_IDS.indexOf(TARGET_PERSON);
        const nextIndex = (currentIndex + 1) % PEOPLE_IDS.length;
        setPerson(PEOPLE_IDS[nextIndex]);
    }, 15000); // 15 seconds
    button.textContent = TRANSLATIONS[CURRENT_LANG].autoOff;
  }

  // 6. Set up periodic data refresh
  setInterval(fetchDashboardData, REFRESH_MS);
});
