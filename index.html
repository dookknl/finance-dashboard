<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>금융 대시보드 (FX 환산 포함)</title>

  <!--
  변경 요약 (2025-10-11):
  - fx_rates.csv 자동 로드 및 KRW 기준 환산 KPI 표시
  - 여러 경로 시도: (1) docs/data/reference/fx_rates.csv (2) data/reference/fx_rates.csv
  - 혼합 통화 경고는 유지하되, KPI는 KRW 기준으로 일관 표시
  - 차트는 "native 통화 기준" 그대로 유지(요청 시 KRW 차트도 확장 가능)
  -->

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,0.06)'
          }
        }
      },
      darkMode: 'class'
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif; }
    .card-details { transition: max-height .3s ease, opacity .3s ease; max-height: 0; overflow: hidden; opacity: 0; }
    .card-details.visible { max-height: 260px; opacity: 1; }
    .skeleton { background: linear-gradient(90deg, rgba(0,0,0,0.06), rgba(0,0,0,0.12), rgba(0,0,0,0.06)); background-size: 200% 100%; animation: shimmer 1.2s infinite; }
    @keyframes shimmer { from { background-position: 200% 0;} to { background-position: -200% 0;} }
    @media (min-width: 1024px) { .main-container { min-height: 100vh; } }
  </style>
</head>
<body class="h-full bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100">
  <div class="main-container mx-auto max-w-7xl p-4 sm:p-6 lg:p-10">
    <div class="flex items-center gap-3 mb-6">
      <div class="flex items-center gap-3">
        <div id="person-icon" class="w-11 h-11 rounded-2xl bg-indigo-600 text-white grid place-items-center shadow-soft"></div>
        <div>
          <h1 id="dashboard-title" class="text-2xl sm:text-3xl font-extrabold" data-i18n="dashboardTitle"></h1>
          <p id="last-updated" class="text-xs text-slate-500 dark:text-slate-400" data-i18n="lastUpdated"></p>
        </div>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <select id="person-select" class="px-3 py-2 rounded-xl text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/70 shadow-soft"></select>
        <select id="lang-select" class="px-3 py-2 rounded-xl text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/70 shadow-soft">
          <option value="ko">한</option>
          <option value="en">E</option>
        </select>
        <button id="toggleTheme" class="px-3 py-2 rounded-xl text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/70 shadow-soft" title="라이트/다크 전환">🌗</button>
        <button id="fullscreen-button" class="px-3 py-2 rounded-xl text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/70 shadow-soft" title="전체 화면">⛶</button>
        <button id="toggle-auto" class="px-3 py-2 rounded-xl text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/70 shadow-soft" title="자동 전환">▶️</button>
      </div>
    </div>

    <div id="status-banner" class="hidden mb-4 rounded-2xl border px-4 py-3 text-sm"></div>

    <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="kpi bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="text-sm text-slate-500 dark:text-slate-400" data-i18n="kpiTotalLabel"></div>
        <div id="kpi-total" class="text-3xl font-extrabold mt-1 tracking-tight">—</div>
        <div id="kpi-total-mm" class="text-xs text-slate-500 mt-1">—</div>
      </div>
      <div class="kpi bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="text-sm text-slate-500 dark:text-slate-400" data-i18n="kpiProfitLossLabel"></div>
        <div id="kpi-pl" class="text-3xl font-extrabold mt-1 tracking-tight">—</div>
        <div id="kpi-pl-rate" class="text-xs mt-1">—</div>
      </div>
      <div class="kpi bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="text-sm text-slate-500 dark:text-slate-400" data-i18n="kpiCashLabel"></div>
        <div id="kpi-cash" class="text-3xl font-extrabold mt-1 tracking-tight">—</div>
        <div class="text-xs text-slate-500 mt-1" data-i18n="kpiCashSubLabel"></div>
      </div>
      <div class="kpi bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="text-sm text-slate-500 dark:text-slate-400" data-i18n="kpiCountLabel"></div>
        <div id="kpi-count" class="text-3xl font-extrabold mt-1 tracking-tight">0</div>
        <div class="text-xs text-slate-500 mt-1" data-i18n="kpiCountSubLabel"></div>
      </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft border border-slate-100 dark:border-slate-800">
        <h2 class="text-lg font-bold mb-4" data-i18n="assetAllocationTitle"></h2>
        <div class="h-[320px]"><canvas id="donut"></canvas></div>
      </div>
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft border border-slate-100 dark:border-slate-800">
        <h2 class="text-lg font-bold mb-4" data-i18n="profitLossByAssetTitle"></h2>
        <div class="h-[320px]"><canvas id="bars"></canvas></div>
      </div>
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="flex items-center gap-2 mb-4">
          <h2 class="text-lg font-bold" data-i18n="portfolioTrendTitle"></h2>
          <span id="timeline-badge" class="ml-2 text-[10px] px-2 py-0.5 rounded-full border border-slate-200 dark:border-slate-700 text-slate-500"></span>
        </div>
        <div class="h-[320px]"><canvas id="line"></canvas></div>
      </div>
    </section>

    <section class="mb-10">
      <div class="flex items-end justify-between mb-3">
        <h2 class="text-xl font-extrabold" data-i18n="holdingsTitle"></h2>
        <div class="text-xs text-slate-500" data-i18n="holdingsSubtitle"></div>
      </div>
      <div id="holdings" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>
    </section>

    <section id="cash-holdings-section" class="mb-10">
      <div class="flex items-end justify-between mb-3">
        <h2 class="text-xl font-extrabold" data-i18n="cashHoldingsTitle"></h2>
      </div>
      <div id="cash-holdings" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    </section>

    <footer class="text-center text-xs text-slate-500 pb-8 opacity-80" data-i18n="footer"></footer>
  </div>

  <script>
    // ===================== CONFIG =====================
    const POSITIONS_URL = "https://raw.githubusercontent.com/dookknl/finance-dashboard/main/docs/data/holdings/positions.csv";
    const ASSETS_URL    = "https://raw.githubusercontent.com/dookknl/finance-dashboard/main/docs/data/reference/assets.csv";
    const PRICES_URL    = "https://raw.githubusercontent.com/dookknl/finance-dashboard/main/docs/data/prices/prices_daily.csv";
    // fx_rates.csv 후보 경로(상대 저장 위치에 따라 둘 다 시도)
    const FX_URLS       = [
      "https://raw.githubusercontent.com/dookknl/finance-dashboard/main/docs/data/reference/fx_rates.csv",
      "https://raw.githubusercontent.com/dookknl/finance-dashboard/main/data/reference/fx_rates.csv",
    ];

    const REFRESH_MS = 5 * 60 * 1000;
    const PEOPLE_MAP = {};
    const PEOPLE_IDS = ['minchae', 'yeonu'];
    let TARGET_PERSON = 'minchae';
    let CURRENT_LANG = 'ko';
    let switcherInterval = null;

    // Global data stores
    let investments = [];
    let cashByCurrency = {};
    let ASSET_MAP = new Map(); // asset_id -> asset row
    let FX_MAP = {};           // "USD_KRW" -> rate
    const FX_BASE = 'KRW';     // KPI 기준 통화

    // Currency symbols map
    const CURRENCY_SYMBOLS = { KRW:'₩', USD:'$', EUR:'€', JPY:'¥', CNY:'¥', GBP:'£' };

    const TRANSLATIONS = {
      ko: {
        dashboardTitle: "의 투자 대시보드",
        lastUpdated: "최근 업데이트: —",
        toggleTheme: "라이트/다크 전환",
        fullScreen: "전체 화면",
        autoOn: "▶️",
        autoOff: "⏸️",
        minchae: "민채",
        yeonu: "연우",
        kpiTotalLabel: `총 평가액 (기준: ${'KRW'})`,
        kpiProfitLossLabel: `총 손익 (기준: ${'KRW'})`,
        kpiCashLabel: "총 현금",
        kpiCashSubLabel: "안전 자산",
        kpiCountLabel: "보유 자산 수",
        kpiCountSubLabel: "펀드 + 현금",
        assetAllocationTitle: "자산 배분",
        profitLossByAssetTitle: "자산별 손익 (native)",
        portfolioTrendTitle: "포트폴리오 추이 (native)",
        holdingsTitle: "보유 자산",
        holdingsSubtitle: "카드를 탭하면 상세가 펼쳐집니다",
        cashHoldingsTitle: "현금 보유",
        footer: "© for 민채 · GitHub Pages & Google Sheets 연동",
        fetchError: "오류: 데이터 파일을 불러오지 못했습니다. — 파일을 확인하세요.",
        fetching: "데이터를 불러오는 중입니다…",
        price: "현재가",
        quantity: "수량",
        cost: "평단가",
        currentValue: "현재 평가액",
        profitLoss: "현재 손익",
        rateOfReturn: "수익률",
        fundCode: "코드",
        noDateData: "날짜 데이터 탐지 안 됨",
        total: "총계",
        mixedCurrencyWarning: `여러 통화가 섞여 있습니다. KPI는 ${'KRW'} 기준 환산으로 표시됩니다.`,
      },
      en: {
        dashboardTitle: "'s Investment Dashboard",
        lastUpdated: "Last Updated: —",
        toggleTheme: "Toggle Theme",
        fullScreen: "Full Screen",
        autoOn: "▶️",
        autoOff: "⏸️",
        minchae: "Minchae",
        yeonu: "Yeonu",
        kpiTotalLabel: `Total Valuation (base: ${'KRW'})`,
        kpiProfitLossLabel: `Total P/L (base: ${'KRW'})`,
        kpiCashLabel: "Total Cash",
        kpiCashSubLabel: "Safe Assets",
        kpiCountLabel: "Total Holdings",
        kpiCountSubLabel: "Funds + Cash",
        assetAllocationTitle: "Asset Allocation",
        profitLossByAssetTitle: "P/L by Asset (native)",
        portfolioTrendTitle: "Portfolio Trend (native)",
        holdingsTitle: "Holdings",
        holdingsSubtitle: "Tap card for details",
        cashHoldingsTitle: "Cash Holdings",
        footer: "© for Minchae · GitHub Pages & Google Sheets Integration",
        fetchError: "Error: Failed to load one or more data files. — Check your files.",
        fetching: "Fetching data…",
        price: "Current Price",
        quantity: "Quantity",
        cost: "Cost per Unit",
        currentValue: "Current Value",
        profitLoss: "Current P/L",
        rateOfReturn: "Return Rate",
        fundCode: "Code",
        noDateData: "No Date Data Detected",
        total: "Total",
        mixedCurrencyWarning: `Mixed currencies detected. KPIs shown in ${'KRW'} base.`,
      }
    };

    // ===================== HELPERS =====================
    const $  = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);
    const SAFE_CSV_SPLIT = /,(?=(?:[^"]*"[^"]*")*[^"]*$)/;

    const nf  = new Intl.NumberFormat('ko-KR');
    const nfc = new Intl.NumberFormat('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function formatCurrency(n, currency) {
      const symbol = CURRENCY_SYMBOLS[currency] || currency || '';
      const val = Number.isFinite(n) ? Math.round(n) : 0;
      return `${symbol}${nf.format(val)}`;
    }

    function toMM(n, currency) {
      const symbol = CURRENCY_SYMBOLS[currency] || currency || '';
      const formatted = nfc.format(((Number.isFinite(n) ? n : 0) / 1_000_000));
      return `${symbol}${formatted} MM`;
    }

    function formatMMOrExact(n, currency) {
      if (!Number.isFinite(n)) return '—';
      return Math.abs(n) < 1_000_000 ? formatCurrency(n, currency) : toMM(n, currency);
    }

    function showBanner(msg, tone='info') {
      const el = $('#status-banner');
      el.textContent = msg;
      el.className = `mb-4 rounded-2xl border px-4 py-3 text-sm`;
      el.classList.add('hidden');
      el.classList.toggle('border-amber-200', tone==='info');
      el.classList.toggle('bg-amber-50', tone==='info');
      el.classList.toggle('text-amber-800', tone==='info');
      el.classList.toggle('border-red-200', tone==='error');
      el.classList.toggle('bg-red-50', tone==='error');
      el.classList.toggle('text-red-700', tone==='error');
      el.classList.remove('hidden');
    }

    function hideBanner(){ $('#status-banner').classList.add('hidden'); }
    function setLastUpdated(){
      const base = TRANSLATIONS[CURRENT_LANG].lastUpdated.split(':')[0];
      $('#last-updated').textContent = `${base}: ${new Date().toLocaleString(CURRENT_LANG === 'ko' ? 'ko-KR' : 'en-US')}`;
    }

    function parseCSV(text) {
      const rows = text.trim().split(/
?
/).filter(r => r && r.trim().length>0);
      if (rows.length === 0) return [];
      const headers = rows[0].split(SAFE_CSV_SPLIT).map(h => h.trim().replace(/"/g, ''));
      const data = [];
      for (let i = 1; i < rows.length; i++) {
        const cols = rows[i].split(SAFE_CSV_SPLIT);
        const row = {};
        headers.forEach((h, idx) => {
          const v = (cols[idx] ?? '').trim().replace(/"/g, '');
          row[h] = v;
        });
        data.push(row);
      }
      return data;
    }

    // ===================== FX =====================
    async function fetchFXRates() {
      for (const url of FX_URLS) {
        try {
          const res = await fetch(url + `?t=${Date.now()}`);
          if (!res.ok) continue;
          const text = await res.text();
          const fxRows = parseCSV(text);
          if (fxRows.length === 0) continue;
          const latestDate = fxRows[fxRows.length - 1].date;
          const map = {};
          fxRows.filter(r => r.date === latestDate).forEach(r => {
            const key = `${r.base}_${r.quote}`;
            const rate = Number(r.rate);
            if (Number.isFinite(rate)) map[key] = rate;
          });
          return map;
        } catch (e) {
          // try next URL
        }
      }
      return {};
    }

    function convert(amount, from, to) {
      if (!Number.isFinite(amount)) return 0;
      if (from === to) return amount;
      const dir = FX_MAP[`${from}_${to}`];
      if (Number.isFinite(dir)) return amount * dir;
      const rev = FX_MAP[`${to}_${from}`];
      if (Number.isFinite(rev) && rev !== 0) return amount / rev;
      return 0; // unknown pair
    }

    // ===================== FETCH & PARSE =====================
    async function fetchDashboardData() {
      showBanner(TRANSLATIONS[CURRENT_LANG].fetching, 'info');
      try {
        const [positionsRes, assetsRes, pricesRes, peopleRes] = await Promise.all([
          fetch(POSITIONS_URL + `?t=${Date.now()}`),
          fetch(ASSETS_URL + `?t=${Date.now()}`),
          fetch(PRICES_URL + `?t=${Date.now()}`),
          fetch(PEOPLE_URL + `?t=${Date.now()}`),
        ]);

        if (!positionsRes.ok || !assetsRes.ok || !pricesRes.ok) {
          throw new Error(TRANSLATIONS[CURRENT_LANG].fetchError);
        }

        // FX 먼저 받아두기
        FX_MAP = await fetchFXRates();

        if (peopleRes.ok) {
          const peopleData = parseCSV(await peopleRes.text());
          peopleData.forEach(p => PEOPLE_MAP[p.id] = p.name);
        }

        const [positionsText, assetsText, pricesText] = await Promise.all([
          positionsRes.text(), assetsRes.text(), pricesRes.text()
        ]);

        const positionsData = parseCSV(positionsText);
        const assetsData    = parseCSV(assetsText);
        const pricesData    = parseCSV(pricesText);

        ASSET_MAP = new Map(assetsData.map(a => [a.asset_id, a]));

        const personPositions = positionsData.filter(pos => pos.person_id === TARGET_PERSON);

        // Build price map
        const pricesMap = new Map(); // asset_id -> [{date, close}]
        pricesData.forEach(p => {
          if (!pricesMap.has(p.asset_id)) pricesMap.set(p.asset_id, []);
          const close = Number(p.close);
          if (Number.isFinite(close)) pricesMap.get(p.asset_id).push({ date: p.date, close });
        });
        for (const arr of pricesMap.values()) arr.sort((a,b)=>a.date.localeCompare(b.date));

        // Populate investments & cash
        investments = [];
        cashByCurrency = {};
        personPositions.forEach(pos => {
          const assetRef = ASSET_MAP.get(pos.asset_id);
          if (!assetRef) return;
          if (assetRef.type === 'cash') {
            const cur = assetRef.currency;
            const qty = Number(pos.qty);
            if (Number.isFinite(qty)) cashByCurrency[cur] = (cashByCurrency[cur] || 0) + qty;
          } else {
            const hist = pricesMap.get(pos.asset_id) || [];
            const lastClose = hist.length ? hist[hist.length-1].close : Number(assetRef.current_price);
            investments.push({
              name: assetRef.short_name || assetRef.name || pos.asset_id,
              fund_cd: pos.asset_id,
              quantity: Number(pos.qty),
              purchasePrice: Number(pos.cost_per_unit),
              currentPrice: Number(lastClose),
              currency: assetRef.currency
            });
          }
        });

        const timeline = buildTimeline(personPositions, pricesMap);
        await renderAll(timeline); // KPI에서 FX 사용
        setLastUpdated();
        hideBanner();

      } catch (e) {
        console.error(e);
        showBanner(e.message, 'error');
      }
    }

    function buildTimeline(positions, pricesMap) {
      const timeline = new Map();
      const dates = new Set();

      // collect all dates from priced assets
      positions.forEach(pos => {
        const pr = pricesMap.get(pos.asset_id);
        if (pr) pr.forEach(p => dates.add(p.date));
      });

      // if there is cash only, synthesize at least one date
      if (dates.size === 0 && Object.keys(cashByCurrency).length > 0) {
        const today = new Date().toISOString().slice(0,10);
        dates.add(today);
      }

      const sortedDates = Array.from(dates).sort();

      // For each date, sum: priced positions at last known <= date + cash (native, no FX on chart)
      sortedDates.forEach(date => {
        let dailyValue = 0;
        positions.forEach(pos => {
          const asset = ASSET_MAP.get(pos.asset_id);
          const qty = Number(pos.qty) || 0;
          if (asset?.type === 'cash') {
            dailyValue += qty; // native sum (chart remains native)
            return;
          }
          const prices = pricesMap.get(pos.asset_id) || [];
          const priceOnOrBefore = prices.filter(p => p.date <= date).sort((a,b)=>b.date.localeCompare(a.date))[0];
          if (priceOnOrBefore) dailyValue += qty * priceOnOrBefore.close;
        });
        timeline.set(date, dailyValue);
      });

      return timeline;
    }

    // ===================== RENDER =====================
    let donutChart, barsChart, lineChart;

    async function renderAll(timeline){
      renderDashboardTitle();
      await renderKPIs();
      renderCashHoldings();
      renderHoldings();
      renderDonut();
      renderBars();
      renderLine(timeline);
    }

    function renderDashboardTitle(){
      const personName = PEOPLE_MAP[TARGET_PERSON] || TRANSLATIONS[CURRENT_LANG][TARGET_PERSON] || TARGET_PERSON;
      $('#dashboard-title').textContent = `${personName}${TRANSLATIONS[CURRENT_LANG].dashboardTitle}`;
      $('#person-icon').textContent = personName.charAt(0).toUpperCase();
      populatePersonSelector();
    }

    function uniqueCurrencies(){
      const curSet = new Set(Object.keys(cashByCurrency));
      investments.forEach(i => curSet.add(i.currency));
      return Array.from(curSet).filter(Boolean);
    }

    async function renderKPIs(){
      const currencies = uniqueCurrencies();
      if (currencies.length > 1) showBanner(TRANSLATIONS[CURRENT_LANG].mixedCurrencyWarning, 'info');

      const { totalVal, totalCost, totalPL, totalCashKRW } = calcTotalsKRW();

      // KPI는 KRW 기준으로 표시
      $('#kpi-total').textContent = formatMMOrExact(totalVal, FX_BASE);
      $('#kpi-total-mm').textContent = formatCurrency(totalVal, FX_BASE);

      const rate = totalCost > 0 ? (totalPL / totalCost) * 100 : 0;
      const plEl = $('#kpi-pl');
      plEl.textContent = `${totalPL >= 0 ? '+' : ''}${formatMMOrExact(Math.abs(totalPL), FX_BASE)}`;
      const rateEl = $('#kpi-pl-rate');
      rateEl.textContent = `${TRANSLATIONS[CURRENT_LANG].rateOfReturn} ${rate >= 0 ? '+' : ''}${nfc.format(rate)}%`;
      plEl.classList.toggle('text-emerald-600', totalPL >= 0);
      plEl.classList.toggle('text-rose-600', totalPL < 0);

      // 현금 KPI (KRW 환산)
      $('#kpi-cash').textContent = formatMMOrExact(totalCashKRW, FX_BASE);
      $('#kpi-count').textContent = String(investments.length + Object.keys(cashByCurrency).length);
    }

    function calcTotalsKRW(){
      let totalValKRW = 0, totalCostKRW = 0, totalCashKRW = 0;

      // Cash (convert to KRW)
      for (const c in cashByCurrency) {
        totalCashKRW += convert(cashByCurrency[c], c, FX_BASE);
      }
      totalValKRW += totalCashKRW;
      totalCostKRW += totalCashKRW; // 현금은 원가 = 현재가로 취급

      // Investments (convert to KRW)
      for (const inv of investments){
        const curValNative = (inv.currentPrice||0) * (inv.quantity||0);
        const costNative   = (inv.purchasePrice||0) * (inv.quantity||0);
        const curValKRW = convert(curValNative, inv.currency, FX_BASE);
        const costKRW   = convert(costNative,   inv.currency, FX_BASE);
        totalValKRW += curValKRW;
        totalCostKRW += costKRW;
      }
      return { totalVal: totalValKRW, totalCost: totalCostKRW, totalPL: totalValKRW - totalCostKRW, totalCashKRW };
    }

    function renderCashHoldings() {
      const wrap = $('#cash-holdings');
      wrap.innerHTML = '';
      if (Object.keys(cashByCurrency).length === 0) {
        $('#cash-holdings-section').style.display = 'none';
      } else {
        $('#cash-holdings-section').style.display = 'block';
        for (const currency in cashByCurrency) {
          const amount = cashByCurrency[currency];
          const card = document.createElement('div');
          card.className = 'bg-white dark:bg-slate-800 rounded-2xl p-5 border border-slate-100 dark:border-slate-800 shadow-soft';
          card.innerHTML = `
            <div class="text-sm text-slate-500 dark:text-slate-400">${TRANSLATIONS[CURRENT_LANG].kpiCashLabel} (${currency})</div>
            <div class="text-3xl font-extrabold mt-1 tracking-tight">${formatMMOrExact(amount, currency)}</div>
            <div class="text-xs text-slate-500 mt-1">${formatCurrency(amount, currency)}</div>
          `;
          wrap.appendChild(card);
        }
      }
    }

    function renderHoldings(){
      const wrap = $('#holdings');
      wrap.innerHTML = '';
      for (const inv of investments){
        const curVal = (inv.quantity||0) * (inv.currentPrice||0);
        const cost   = (inv.quantity||0) * (inv.purchasePrice||0);
        const pl     = curVal - cost;
        const gain   = pl >= 0;
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-slate-800 rounded-2xl p-5 border border-slate-100 dark:border-slate-800 shadow-soft hover:shadow transition-all cursor-pointer';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="text-lg font-bold">${inv.name}</h3>
              <div class="text-xs text-slate-500" data-i18n="fundCode">${TRANSLATIONS[CURRENT_LANG].fundCode}: ${inv.fund_cd}</div>
            </div>
            <div class="text-right">
              <div class="text-sm text-slate-500" data-i18n="currentValue">${TRANSLATIONS[CURRENT_LANG].currentValue}</div>
              <div class="text-xl font-extrabold">${formatMMOrExact(curVal, inv.currency)}</div>
              <div class="text-xs text-slate-500">${formatCurrency(curVal, inv.currency)}</div>
            </div>
          </div>
          <div class="card-details mt-4 text-sm">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <div class="text-slate-500" data-i18n="quantity">${TRANSLATIONS[CURRENT_LANG].quantity}</div>
                <div class="font-semibold">${nf.format(inv.quantity||0)}</div>
              </div>
              <div>
                <div class="text-slate-500" data-i18n="cost">${TRANSLATIONS[CURRENT_LANG].cost}</div>
                <div class="font-semibold">${formatCurrency(inv.purchasePrice, inv.currency)}</div>
              </div>
              <div>
                <div class="text-slate-500" data-i18n="price">${TRANSLATIONS[CURRENT_LANG].price}</div>
                <div class="font-semibold">${Number.isFinite(inv.currentPrice) ? formatCurrency(inv.currentPrice, inv.currency) : '—'}</div>
              </div>
              <div>
                <div class="text-slate-500" data-i18n="profitLoss">${TRANSLATIONS[CURRENT_LANG].profitLoss}</div>
                <div class="font-semibold ${gain ? 'text-emerald-600' : 'text-rose-600'}">${gain ? '+' : ''}${formatCurrency(Math.abs(pl), inv.currency)}</div>
              </div>
            </div>
          </div>
        `;
        card.addEventListener('click', () => card.querySelector('.card-details').classList.toggle('visible'));
        wrap.appendChild(card);
      }
    }

    function renderDonut(){
      const cashTotal = Object.values(cashByCurrency).reduce((sum, val) => sum + (Number(val)||0), 0);
      const labels = [...investments.map(i => i.name), TRANSLATIONS[CURRENT_LANG].kpiCashLabel];
      const data = [
        ...investments.map(i => (i.quantity||0) * (i.currentPrice || 0)),
        cashTotal
      ];
      if (donutChart) donutChart.destroy();
      donutChart = new Chart($('#donut').getContext('2d'), {
        type: 'doughnut',
        data: { labels, datasets: [{ data }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: ctx => `${ctx.label}: ${toMM(ctx.parsed, '')} (native)` } } }
        }
      });
    }

    function renderBars(){
      const labels = investments.map(i => i.name);
      const currentValues = investments.map(i => (i.quantity||0) * (i.currentPrice || 0));
      const initialCosts  = investments.map(i => (i.quantity||0) * (i.purchasePrice || 0));

      if (barsChart) barsChart.destroy();
      barsChart = new Chart($('#bars').getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Current Value (native, MM)', data: currentValues, borderWidth: 1 },
            { label: 'Initial Cost (native, MM)',  data: initialCosts,  borderWidth: 1 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { callback: v => `${(v/1_000_000).toFixed(1)} MM` }
            },
            x: { stacked: false }
          },
          plugins: {
            legend: { display: true },
            tooltip: { callbacks: { label: c => ` ${c.dataset.label}: ${(c.parsed.y/1_000_000).toFixed(1)} MM` } }
          }
        }
      });
    }

    function renderLine(timeline){
      const badge = $('#timeline-badge');
      if (!timeline || timeline.size === 0){
        badge.textContent = TRANSLATIONS[CURRENT_LANG].noDateData;
        if (lineChart) { lineChart.destroy(); lineChart = null; }
        const ctx = $('#line').getContext('2d');
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        return;
      }

      const rawLabels = Array.from(timeline.keys());
      const data = Array.from(timeline.values());
      const labels = rawLabels.map(d => { const [y,m] = d.split('-'); return `${y.slice(2)}-${m}`; });

      badge.textContent = `${rawLabels[0]} ~ ${rawLabels[rawLabels.length - 1]}`;

      if (lineChart) lineChart.destroy();
      lineChart = new Chart($('#line').getContext('2d'), {
        type: 'line',
        data: { labels, datasets: [{ label: 'Total Value (native, MM)', data, tension: 0.3, fill: true }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: false, ticks: { callback: v => `${(v/1_000_000).toFixed(1)} MM` } },
            x: { ticks: { autoSkip: false, maxRotation: 0, minRotation: 0 } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: c => ` ${(c.parsed.y/1_000_000).toFixed(1)} MM` } }
          }
        }
      });
    }

    // ===================== INTERACTION =====================
    function setPerson(personId) {
      TARGET_PERSON = personId;
      localStorage.setItem('targetPerson', personId);
      $('#person-select').value = personId;
      fetchDashboardData();
    }

    function setLanguage(lang) {
      CURRENT_LANG = lang;
      localStorage.setItem('dashboardLang', lang);
      applyTranslations(lang);
    }

    function enterFullscreen(){
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
    }

    function applyStoredTheme(){
      const stored = localStorage.getItem('theme-mode');
      if (stored === 'dark') document.documentElement.classList.add('dark');
    }

    function toggleTheme(){
      const html = document.documentElement;
      html.classList.toggle('dark');
      localStorage.setItem('theme-mode', html.classList.contains('dark') ? 'dark' : 'light');
    }

    function toggleSwitcher() {
      const button = $('#toggle-auto');
      if (switcherInterval) {
        clearInterval(switcherInterval); switcherInterval = null;
        button.textContent = TRANSLATIONS[CURRENT_LANG].autoOn;
      } else {
        switcherInterval = setInterval(() => {
          const idx = PEOPLE_IDS.indexOf(TARGET_PERSON);
          const next = (idx + 1) % PEOPLE_IDS.length;
          setPerson(PEOPLE_IDS[next]);
        }, 15000);
        button.textContent = TRANSLATIONS[CURRENT_LANG].autoOff;
      }
      localStorage.setItem('autoSwitchEnabled', Boolean(switcherInterval).toString());
    }

    function populatePersonSelector() {
      const selector = $('#person-select');
      const current = selector.value;
      selector.innerHTML = '';
      for (const id of PEOPLE_IDS) {
        const label = PEOPLE_MAP[id] || TRANSLATIONS[CURRENT_LANG][id] || id.charAt(0).toUpperCase();
        const option = document.createElement('option');
        option.value = id; option.textContent = label; selector.appendChild(option);
      }
      selector.value = current || TARGET_PERSON;
    }

    function applyTranslations(lang) {
      $$('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const text = TRANSLATIONS[lang][key];
        if (!text) return;
        if (el.tagName === 'OPTION') el.textContent = text; else el.textContent = text;
      });
      renderDashboardTitle();
      const autoButton = $('#toggle-auto');
      autoButton.textContent = switcherInterval ? TRANSLATIONS[CURRENT_LANG].autoOff : TRANSLATIONS[CURRENT_LANG].autoOn;
      fetchDashboardData();
    }

    // ===================== INIT =====================
    window.addEventListener('load', () => {
      applyStoredTheme();
      const storedPerson = localStorage.getItem('targetPerson');
      TARGET_PERSON = storedPerson || TARGET_PERSON; localStorage.setItem('targetPerson', TARGET_PERSON);

      const storedLang = localStorage.getItem('dashboardLang');
      CURRENT_LANG = storedLang || CURRENT_LANG; localStorage.setItem('dashboardLang', CURRENT_LANG);
      $('#lang-select').value = CURRENT_LANG;

      const autoSwitchEnabled = localStorage.getItem('autoSwitchEnabled');
      if (autoSwitchEnabled === 'true') toggleSwitcher();

      populatePersonSelector();

      $('#toggleTheme').addEventListener('click', toggleTheme);
      $('#fullscreen-button').addEventListener('click', enterFullscreen);
      $('#person-select').addEventListener('change', (e) => setPerson(e.target.value));
      $('#lang-select').addEventListener('change', (e) => setLanguage(e.target.value));
      $('#toggle-auto').addEventListener('click', toggleSwitcher);

      applyTranslations(CURRENT_LANG);
      setInterval(fetchDashboardData, REFRESH_MS);
    });
  </script>
</body>
</html>
