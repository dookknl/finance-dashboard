<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Í∏àÏúµ ÎåÄÏãúÎ≥¥Îìú</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,0.06)' }
        }
      },
      darkMode: 'class'
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif; }
    .card-details { transition: max-height .3s ease, opacity .3s ease; max-height: 0; overflow: hidden; opacity: 0; }
    .card-details.visible { max-height: 260px; opacity: 1; }
    .skeleton { background: linear-gradient(90deg, rgba(0,0,0,0.06), rgba(0,0,0,0.12), rgba(0,0,0,0.06)); background-size: 200% 100%; animation: shimmer 1.2s infinite; }
    @keyframes shimmer { from { background-position: 200% 0;} to { background-position: -200% 0;} }
    @media (min-width: 1024px) { .main-container { min-height: 100vh; } }
  </style>
</head>
<body class="h-full bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100">
  <div class="main-container mx-auto max-w-7xl p-4 sm:p-6 lg:p-10">
    <div class="flex items-center gap-3 mb-6">
      <div class="flex items-center gap-3">
        <div id="person-icon" class="w-11 h-11 rounded-2xl bg-indigo-600 text-white grid place-items-center shadow-soft"></div>
        <div>
          <h1 id="dashboard-title" class="text-2xl sm:text-3xl font-extrabold" data-i18n="dashboardTitle"></h1>
          <p id="last-updated" class="text-xs text-slate-500 dark:text-slate-400" data-i18n="lastUpdated"></p>
        </div>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <select id="person-select" class="px-3 py-2 rounded-xl text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/70 shadow-soft"></select>
        <select id="lang-select" class="px-3 py-2 rounded-xl text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/70 shadow-soft">
          <option value="ko">Ìïú</option>
          <option value="en">E</option>
        </select>
        <button id="toggleTheme" class="px-3 py-2 rounded-xl text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/70 shadow-soft" title="ÎùºÏù¥Ìä∏/Îã§ÌÅ¨ Ï†ÑÌôò">üåó</button>
        <button id="fullscreen-button" class="px-3 py-2 rounded-xl text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/70 shadow-soft" title="Ï†ÑÏ≤¥ ÌôîÎ©¥">‚õ∂</button>
        <button id="toggle-auto" class="px-3 py-2 rounded-xl text-sm bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800/70 shadow-soft" title="ÏûêÎèô Ï†ÑÌôò">‚ñ∂Ô∏è</button>
      </div>
    </div>

    <div id="status-banner" class="hidden mb-4 rounded-2xl border px-4 py-3 text-sm"></div>

    <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="kpi bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="text-sm text-slate-500 dark:text-slate-400" data-i18n="kpiTotalLabel"></div>
        <div id="kpi-total" class="text-3xl font-extrabold mt-1 tracking-tight">‚Ç©0</div>
        <div id="kpi-total-mm" class="text-xs text-slate-500 mt-1">‚Ç©0.00 MM</div>
      </div>
      <div class="kpi bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="text-sm text-slate-500 dark:text-slate-400" data-i18n="kpiProfitLossLabel"></div>
        <div id="kpi-pl" class="text-3xl font-extrabold mt-1 tracking-tight">‚Ç©0</div>
        <div id="kpi-pl-rate" class="text-xs mt-1">‚Äî</div>
      </div>
      <div class="kpi bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="text-sm text-slate-500 dark:text-slate-400" data-i18n="kpiCashLabel"></div>
        <div id="kpi-cash" class="text-3xl font-extrabold mt-1 tracking-tight">‚Ç©0</div>
        <div class="text-xs text-slate-500 mt-1" data-i18n="kpiCashSubLabel"></div>
      </div>
      <div class="kpi bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="text-sm text-slate-500 dark:text-slate-400" data-i18n="kpiCountLabel"></div>
        <div id="kpi-count" class="text-3xl font-extrabold mt-1 tracking-tight">0</div>
        <div class="text-xs text-slate-500 mt-1" data-i18n="kpiCountSubLabel"></div>
      </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="flex items-center gap-2 mb-4">
          <h2 class="text-lg font-bold" data-i18n="assetAllocationTitle"></h2>
        </div>
        <div class="h-[320px]"><canvas id="donut"></canvas></div>
      </div>

      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="flex items-center gap-2 mb-4">
          <h2 class="text-lg font-bold" data-i18n="profitLossByAssetTitle"></h2>
          <!-- Îã®ÏúÑ Î∞∞ÏßÄ -->
          <span class="text-[10px] px-2 py-0.5 rounded-full border border-slate-200 dark:border-slate-700 text-slate-500">‚Ç© ¬∑ MM</span>
        </div>
        <div class="h-[320px]"><canvas id="bars"></canvas></div>
      </div>

      <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-soft border border-slate-100 dark:border-slate-800">
        <div class="flex items-center gap-2 mb-4">
          <h2 class="text-lg font-bold" data-i18n="portfolioTrendTitle"></h2>
          <!-- Îã®ÏúÑ Î∞∞ÏßÄ -->
          <span class="text-[10px] px-2 py-0.5 rounded-full border border-slate-200 dark:border-slate-700 text-slate-500">‚Ç© ¬∑ MM</span>
          <span id="timeline-badge" class="ml-2 text-[10px] px-2 py-0.5 rounded-full border border-slate-200 dark:border-slate-700 text-slate-500"></span>
        </div>
        <div class="h-[320px]"><canvas id="line"></canvas></div>
      </div>
    </section>

    <section class="mb-10">
      <div class="flex items-end justify-between mb-3">
        <h2 class="text-xl font-extrabold" data-i18n="holdingsTitle"></h2>
        <div class="text-xs text-slate-500" data-i18n="holdingsSubtitle"></div>
      </div>
      <div id="holdings" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>
    </section>

    <section id="cash-holdings-section" class="mb-10">
      <div class="flex items-end justify-between mb-3">
        <h2 class="text-xl font-extrabold" data-i18n="cashHoldingsTitle"></h2>
      </div>
      <div id="cash-holdings" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    </section>

    <footer class="text-center text-xs text-slate-500 pb-8 opacity-80" data-i18n="footer"></footer>
  </div>

  <script>
    // ===================== CONFIG =====================
    const POSITIONS_URL = "https://raw.githubusercontent.com/dookknl/finance-dashboard/main/docs/data/holdings/positions.csv";
    const ASSETS_URL = "https://raw.githubusercontent.com/dookknl/finance-dashboard/main/docs/data/reference/assets.csv";
    const PRICES_URL = "https://raw.githubusercontent.com/dookknl/finance-dashboard/main/docs/data/prices/prices_daily.csv";
    const PEOPLE_URL = "https://raw.githubusercontent.com/dookknl/finance-dashboard/main/docs/data/reference/people.csv";

    const REFRESH_MS = 5 * 60 * 1000;
    const PEOPLE_MAP = {};
    const PEOPLE_IDS = ['minchae', 'yeonu'];
    let TARGET_PERSON = 'minchae';
    let CURRENT_LANG = 'ko';
    let switcherInterval = null;

    // Global data stores
    let investments = [];
    let cashByCurrency = {};
    const MM_THRESHOLD = 1000000; // 1 million

    // Currency symbols map
    const CURRENCY_SYMBOLS = { 'KRW':'‚Ç©','USD':'$','EUR':'‚Ç¨','JPY':'¬•','CNY':'¬•' };

    const TRANSLATIONS = {
      ko: {
        dashboardTitle: "Ïùò Ìà¨Ïûê ÎåÄÏãúÎ≥¥Îìú",
        lastUpdated: "ÏµúÍ∑º ÏóÖÎç∞Ïù¥Ìä∏: ‚Äî",
        toggleTheme: "ÎùºÏù¥Ìä∏/Îã§ÌÅ¨ Ï†ÑÌôò",
        fullScreen: "Ï†ÑÏ≤¥ ÌôîÎ©¥",
        autoOn: "‚ñ∂Ô∏è",
        autoOff: "‚è∏Ô∏è",
        minchae: "ÎØºÏ±Ñ",
        yeonu: "Yeonu",
        kpiTotalLabel: "Ï¥ù ÌèâÍ∞ÄÏï°",
        kpiProfitLossLabel: "Ï¥ù ÏÜêÏùµ",
        kpiCashLabel: "Ï¥ù ÌòÑÍ∏à",
        kpiCashSubLabel: "ÏïàÏ†Ñ ÏûêÏÇ∞",
        kpiCountLabel: "Î≥¥Ïú† ÏûêÏÇ∞ Ïàò",
        kpiCountSubLabel: "ÌéÄÎìú + ÌòÑÍ∏à",
        assetAllocationTitle: "ÏûêÏÇ∞ Î∞∞Î∂Ñ",
        profitLossByAssetTitle: "ÏûêÏÇ∞Î≥Ñ ÏÜêÏùµ",
        portfolioTrendTitle: "Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Ï∂îÏù¥",
        holdingsTitle: "Î≥¥Ïú† ÏûêÏÇ∞",
        holdingsSubtitle: "Ïπ¥ÎìúÎ•º ÌÉ≠ÌïòÎ©¥ ÏÉÅÏÑ∏Í∞Ä ÌéºÏ≥êÏßëÎãàÎã§",
        cashHoldingsTitle: "ÌòÑÍ∏à Î≥¥Ïú†",
        footer: "¬© for ÎØºÏ±Ñ ¬∑ GitHub Pages & Google Sheets Ïó∞Îèô",
        fetchError: "Ïò§Î•ò: Îç∞Ïù¥ÌÑ∞ ÌååÏùºÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§. ‚Äî ÌååÏùºÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.",
        fetching: "Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§‚Ä¶",
        price: "ÌòÑÏû¨Í∞Ä",
        quantity: "ÏàòÎüâ",
        cost: "ÌèâÎã®Í∞Ä",
        currentValue: "ÌòÑÏû¨ ÌèâÍ∞ÄÏï°",
        profitLoss: "ÌòÑÏû¨ ÏÜêÏùµ",
        rateOfReturn: "ÏàòÏùµÎ•†",
        fundCode: "ÏΩîÎìú",
        noDateData: "ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞ ÌÉêÏßÄ Ïïà Îê®",
        total: "Ï¥ùÍ≥Ñ"
      },
      en: {
        dashboardTitle: "'s Investment Dashboard",
        lastUpdated: "Last Updated: ‚Äî",
        toggleTheme: "Toggle Theme",
        fullScreen: "Full Screen",
        autoOn: "‚ñ∂Ô∏è",
        autoOff: "‚è∏Ô∏è",
        minchae: "Minchae",
        yeonu: "Yeonu",
        kpiTotalLabel: "Total Valuation",
        kpiProfitLossLabel: "Total P/L",
        kpiCashLabel: "Total Cash",
        kpiCashSubLabel: "Safe Assets",
        kpiCountLabel: "Total Holdings",
        kpiCountSubLabel: "Funds + Cash",
        assetAllocationTitle: "Asset Allocation",
        profitLossByAssetTitle: "P/L by Asset",
        portfolioTrendTitle: "Portfolio Trend",
        holdingsTitle: "Holdings",
        holdingsSubtitle: "Tap card for details",
        cashHoldingsTitle: "Cash Holdings",
        footer: "¬© for Minchae ¬∑ GitHub Pages & Google Sheets Integration",
        fetchError: "Error: Failed to load one or more data files. ‚Äî Check your files.",
        fetching: "Fetching data‚Ä¶",
        price: "Current Price",
        quantity: "Quantity",
        cost: "Cost per Unit",
        currentValue: "Current Value",
        profitLoss: "Current P/L",
        rateOfReturn: "Return Rate",
        fundCode: "Code",
        noDateData: "No Date Data Detected",
        total: "Total"
      }
    };

    // ===================== HELPERS =====================
    const $  = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);
    const SAFE_CSV_SPLIT = /,(?=(?:[^"]*"[^"]*")*[^"]*$)/;

    const nf  = new Intl.NumberFormat('ko-KR');
    const nfc = new Intl.NumberFormat('ko-KR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    function formatCurrency(n, currency) {
      const symbol = CURRENCY_SYMBOLS[currency] || currency;
      return `${symbol}${nf.format(Math.round(n || 0))}`;
    }
    function toMM(n, currency) {
      const symbol = CURRENCY_SYMBOLS[currency] || currency;
      const formatted = nfc.format((n || 0) / 1_000_000);
      return `${symbol}${formatted} MM`;
    }
    function formatMMOrExact(n, currency) {
      return Math.abs(n) < 1_000_000 ? formatCurrency(n, currency) : toMM(n, currency);
    }
    function showBanner(msg, tone='info') {
      const el = $('#status-banner');
      el.textContent = msg;
      el.className = `mb-4 rounded-2xl border px-4 py-3 text-sm`;
      el.classList.add('hidden');
      el.classList.toggle('border-amber-200', tone==='info');
      el.classList.toggle('bg-amber-50', tone==='info');
      el.classList.toggle('text-amber-800', tone==='info');
      el.classList.toggle('border-red-200', tone==='error');
      el.classList.toggle('bg-red-50', tone==='error');
      el.classList.toggle('text-red-700', tone==='error');
      el.classList.remove('hidden');
    }
    function hideBanner(){ $('#status-banner').classList.add('hidden'); }
    function setLastUpdated(){
      $('#last-updated').textContent =
        `${TRANSLATIONS[CURRENT_LANG].lastUpdated.split(':')[0]}: ${new Date().toLocaleString(CURRENT_LANG === 'ko' ? 'ko-KR' : 'en-US')}`;
    }
    function parseCSV(text) {
      const rows = text.trim().split(/\r?\n/);
      const headers = rows[0].split(SAFE_CSV_SPLIT).map(h => h.trim().replace(/"/g, ''));
      const data = [];
      for (let i = 1; i < rows.length; i++) {
        const values = rows[i].split(SAFE_CSV_SPLIT).map(v => v.trim().replace(/"/g, ''));
        const row = {}; headers.forEach((h, idx) => { row[h] = values[idx]; });
        data.push(row);
      }
      return data;
    }
    function applyTranslations(lang) {
      $$('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const text = TRANSLATIONS[lang][key];
        if (!text) return;
        if (el.tagName === 'OPTION') el.textContent = text;
        else el.textContent = text;
      });
      renderDashboardTitle();
      const autoButton = $('#toggle-auto');
      autoButton.textContent = switcherInterval ? TRANSLATIONS[CURRENT_LANG].autoOff : TRANSLATIONS[CURRENT_LANG].autoOn;
      fetchDashboardData();
    }

    // ---- Date helpers for dynamic X-axis ticks ----
    const DAY_MS = 24*60*60*1000;
    function parseISO(d){ const [y,m,dd] = d.split('-').map(Number); return new Date(y, m-1, dd); }
    function diffDays(a, b){ return Math.round((parseISO(b) - parseISO(a)) / DAY_MS); }
    function isMonthStart(d){ return parseISO(d).getDate() === 1; }
    function isQuarterStart(d){
      const dt = parseISO(d); const m = dt.getMonth()+1; // 1..12
      return dt.getDate() === 1 && (m===1 || m===4 || m===7 || m===10);
    }
    function pickTickLevel(startISO, endISO){
      const days = diffDays(startISO, endISO);
      if (days <= 90)   return 'weekly';
      if (days <= 180)  return 'biweekly';
      if (days <= 540)  return 'monthly';
      return 'quarterly';
    }

    // ===================== FETCH & PARSE =====================
    async function fetchDashboardData() {
      showBanner(TRANSLATIONS[CURRENT_LANG].fetching, 'info');
      try {
        const [positionsRes, assetsRes, pricesRes, peopleRes] = await Promise.all([
          fetch(POSITIONS_URL + `?t=${Date.now()}`),
          fetch(ASSETS_URL + `?t=${Date.now()}`),
          fetch(PRICES_URL + `?t=${Date.now()}`),
          fetch(PEOPLE_URL + `?t=${Date.now()}`),
        ]);
        if (!positionsRes.ok || !assetsRes.ok || !pricesRes.ok) {
          throw new Error(TRANSLATIONS[CURRENT_LANG].fetchError);
        }
        if (peopleRes.ok) {
          const peopleData = parseCSV(await peopleRes.text());
          peopleData.forEach(p => PEOPLE_MAP[p.id] = p.name);
        }

        const positionsText = await positionsRes.text();
        const assetsText    = await assetsRes.text();
        const pricesText    = await pricesRes.text();

        const positionsData = parseCSV(positionsText);
        const assetsData    = parseCSV(assetsText);
        const pricesData    = parseCSV(pricesText);

        const personPositions = positionsData.filter(pos => pos.person_id === TARGET_PERSON);

        const assetMap = new Map();
        assetsData.forEach(asset => { assetMap.set(asset.asset_id, asset); });

        const pricesMap = new Map();
        pricesData.forEach(price => {
          if (!pricesMap.has(price.asset_id)) pricesMap.set(price.asset_id, []);
          pricesMap.get(price.asset_id).push({ date: price.date, close: Number(price.close) });
        });

        // Populate investments and cash holdings
        investments = [];
        cashByCurrency = {};
        personPositions.forEach(pos => {
          const assetRef = assetMap.get(pos.asset_id);
          if (!assetRef) return;

          if (assetRef.type === 'cash') {
            const currency = assetRef.currency;
            cashByCurrency[currency] = (cashByCurrency[currency] || 0) + Number(pos.qty);
          } else {
            const latestPrice = (pricesMap.get(pos.asset_id) || []).slice(-1)[0]?.close || Number(assetRef.current_price);
            investments.push({
              name: assetRef.short_name,
              fund_cd: pos.asset_id,
              quantity: Number(pos.qty),
              purchasePrice: Number(pos.cost_per_unit),
              currentPrice: latestPrice,
              currency: assetRef.currency
            });
          }
        });

        const timeline = buildTimeline(personPositions, pricesMap);
        renderAll(timeline);
        setLastUpdated();
        hideBanner();

      } catch (e) {
        console.error(e);
        showBanner(e.message, 'error');
      }
    }

    function buildTimeline(positions, pricesMap) {
      const timeline = new Map();
      const dates = new Set();

      positions.forEach(pos => {
        const assetPrices = pricesMap.get(pos.asset_id);
        if (!assetPrices) return;
        assetPrices.forEach(price => dates.add(price.date));
      });

      const sortedDates = Array.from(dates).sort();

      sortedDates.forEach(date => {
        let dailyValue = 0;
        positions.forEach(pos => {
          const pricesForAsset = pricesMap.get(pos.asset_id) || [];
          const priceOnDate = pricesForAsset
            .filter(p => p.date <= date)
            .sort((a, b) => b.date.localeCompare(a.date))[0];

          if (priceOnDate) {
            dailyValue += Number(pos.qty) * priceOnDate.close;
          } else if (pos.asset_id.startsWith('CASH')) {
            dailyValue += Number(pos.qty);
          }
        });
        timeline.set(date, dailyValue);
      });

      return timeline;
    }

    // ===================== RENDER =====================
    let donutChart, barsChart, lineChart;

    function renderAll(timeline){
      renderDashboardTitle();
      renderKPIs();
      renderCashHoldings();
      renderHoldings();
      renderDonut();
      renderBars();
      renderLine(timeline);
    }

    function renderDashboardTitle(){
      const personName = PEOPLE_MAP[TARGET_PERSON] || TARGET_PERSON;
      $('#dashboard-title').textContent = `${personName}${TRANSLATIONS[CURRENT_LANG].dashboardTitle}`;
      $('#person-icon').textContent = personName.charAt(0).toUpperCase();
    }

    function calcTotals(){
      let totalVal = 0, totalCost = 0, totalCash = 0;
      for (const currency in cashByCurrency) totalCash += cashByCurrency[currency]; // (Ï£ºÏùò) ÌÜµÌôî ÌòºÌï© Ïãú ÌôòÏÇ∞ ÌïÑÏöî
      totalVal += totalCash; totalCost += totalCash;
      for (const inv of investments){
        const curVal = (inv.currentPrice||0) * inv.quantity;
        const cost = inv.purchasePrice * inv.quantity;
        totalVal += curVal; totalCost += cost;
      }
      return { totalVal, totalCost, totalPL: totalVal - totalCost, totalCash };
    }

    function renderKPIs(){
      const { totalVal, totalCost, totalPL, totalCash } = calcTotals();
      $('#kpi-total').textContent = formatMMOrExact(totalVal, 'KRW');
      $('#kpi-total-mm').textContent = formatCurrency(totalVal, 'KRW');
      $('#kpi-cash').textContent = formatMMOrExact(totalCash, 'KRW');
      $('#kpi-count').textContent = String(investments.length + Object.keys(cashByCurrency).length);

      const rate = totalCost > 0 ? (totalPL / totalCost) * 100 : 0;
      const plEl = $('#kpi-pl');
      plEl.textContent = `${totalPL >= 0 ? '+' : ''}${formatMMOrExact(Math.abs(totalPL), 'KRW')}`;
      const rateEl = $('#kpi-pl-rate');
      rateEl.textContent = `${TRANSLATIONS[CURRENT_LANG].rateOfReturn} ${rate >= 0 ? '+' : ''}${nfc.format(rate)}%`;
      plEl.classList.toggle('text-emerald-600', totalPL >= 0);
      plEl.classList.toggle('text-rose-600', totalPL < 0);
    }

    function renderCashHoldings() {
      const wrap = $('#cash-holdings');
      wrap.innerHTML = '';
      if (Object.keys(cashByCurrency).length === 0) {
        $('#cash-holdings-section').style.display = 'none';
      } else {
        $('#cash-holdings-section').style.display = 'block';
        for (const currency in cashByCurrency) {
          const amount = cashByCurrency[currency];
          const card = document.createElement('div');
          card.className = 'bg-white dark:bg-slate-800 rounded-2xl p-5 border border-slate-100 dark:border-slate-800 shadow-soft';
          card.innerHTML = `
            <div class="text-sm text-slate-500 dark:text-slate-400">${TRANSLATIONS[CURRENT_LANG].kpiCashLabel} (${currency})</div>
            <div class="text-3xl font-extrabold mt-1 tracking-tight">${formatMMOrExact(amount, currency)}</div>
            <div class="text-xs text-slate-500 mt-1">${formatCurrency(amount, currency)}</div>
          `;
          wrap.appendChild(card);
        }
      }
    }

    function renderHoldings(){
      const wrap = $('#holdings');
      wrap.innerHTML = '';
      for (const inv of investments){
        const curVal = inv.quantity * (inv.currentPrice||0);
        const cost   = inv.quantity * inv.purchasePrice;
        const pl     = curVal - cost;
        const gain   = pl >= 0;
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-slate-800 rounded-2xl p-5 border border-slate-100 dark:border-slate-800 shadow-soft hover:shadow transition-all cursor-pointer';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="text-lg font-bold">${inv.name}</h3>
              <div class="text-xs text-slate-500" data-i18n="fundCode">${TRANSLATIONS[CURRENT_LANG].fundCode}: ${inv.fund_cd}</div>
            </div>
            <div class="text-right">
              <div class="text-sm text-slate-500" data-i18n="currentValue">${TRANSLATIONS[CURRENT_LANG].currentValue}</div>
              <div class="text-xl font-extrabold">${formatMMOrExact(curVal, inv.currency)}</div>
              <div class="text-xs text-slate-500">${formatCurrency(curVal, inv.currency)}</div>
            </div>
          </div>
          <div class="card-details mt-4 text-sm">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <div class="text-slate-500" data-i18n="quantity">${TRANSLATIONS[CURRENT_LANG].quantity}</div>
                <div class="font-semibold">${nf.format(inv.quantity)}</div>
              </div>
              <div>
                <div class="text-slate-500" data-i18n="cost">${TRANSLATIONS[CURRENT_LANG].cost}</div>
                <div class="font-semibold">${formatCurrency(inv.purchasePrice, inv.currency)}</div>
              </div>
              <div>
                <div class="text-slate-500" data-i18n="price">${TRANSLATIONS[CURRENT_LANG].price}</div>
                <div class="font-semibold">${inv.currentPrice ? formatCurrency(inv.currentPrice, inv.currency) : '‚Äî'}</div>
              </div>
              <div>
                <div class="text-slate-500" data-i18n="profitLoss">${TRANSLATIONS[CURRENT_LANG].profitLoss}</div>
                <div class="font-semibold ${gain ? 'text-emerald-600' : 'text-rose-600'}">${gain ? '+' : ''}${formatCurrency(Math.abs(pl), inv.currency)}</div>
              </div>
            </div>
          </div>
        `;
        card.addEventListener('click', () => card.querySelector('.card-details').classList.toggle('visible'));
        wrap.appendChild(card);
      }
    }

    function renderDonut(){
      const cashTotal = Object.values(cashByCurrency).reduce((sum, val) => sum + val, 0);
      const labels = [...investments.map(i => i.name), TRANSLATIONS[CURRENT_LANG].kpiCashLabel];
      const data   = [...investments.map(i => i.quantity * (i.currentPrice || 0)), cashTotal];
      if (donutChart) donutChart.destroy();
      donutChart = new Chart($('#donut').getContext('2d'), {
        type: 'doughnut',
        data: { labels, datasets: [{ data }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatMMOrExact(ctx.parsed, 'KRW')}` } }
          }
        }
      });
    }

    // ---- P/L by Asset: YÏ∂ï Ï†ïÏàò(Î∞±Îßå), Ïã¨Î≥º/Îã®ÏúÑ Ï†úÍ±∞. Ìà¥ÌåÅÏùÄ Ï†ïÏàò MM.
    function renderBars(){
      const labels = investments.map(i => i.name);
      const currentValues = investments.map(i => i.quantity * (i.currentPrice || 0));
      const initialCosts  = investments.map(i => i.quantity * i.purchasePrice);

      if (barsChart) barsChart.destroy();
      barsChart = new Chart($('#bars').getContext('2d'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Current Value', data: currentValues, borderWidth: 1 },
            { label: 'Initial Cost',  data: initialCosts,  borderWidth: 1 }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          layout: { padding: { left: 0 } },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: v => Math.round(v / 1_000_000), // Ï†ïÏàò MM
                precision: 0,
                maxTicksLimit: 6
              },
              grid: { drawBorder: false }
            },
            x: { stacked: false }
          },
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: c => ` ${c.dataset.label}: ‚Ç©${Math.round(c.parsed.y / 1_000_000)} MM`
              }
            }
          }
        }
      });
    }

    // ---- Portfolio Trend: Îã§Ïù¥ÎÇ¥ÎØπ XÏ∂ï + YÏ∂ï Ï†ïÏàò(Î∞±Îßå), Ìà¥ÌåÅ Ï†ïÏàò MM.
    function renderLine(timeline){
      const badge = $('#timeline-badge');
      if (!timeline || timeline.size === 0){
        badge.textContent = TRANSLATIONS[CURRENT_LANG].noDateData;
        if (lineChart) { lineChart.destroy(); lineChart = null; }
        const ctx = $('#line').getContext('2d');
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        return;
      }

      const rawDates = Array.from(timeline.keys()); // 'YYYY-MM-DD'
      const data     = Array.from(timeline.values());

      const startISO = rawDates[0];
      const endISO   = rawDates[rawDates.length - 1];
      const level    = pickTickLevel(startISO, endISO);
      badge.textContent = `${startISO} ~ ${endISO}`;

      const fmtLabel = (d) => {
        const [y,m,dd] = d.split('-');
        if (level === 'weekly' || level === 'biweekly') return `${y.slice(2)}-${m}-${dd}`;
        if (level === 'monthly') return `${y.slice(2)}-${m}`;
        return `${y} Q${Math.floor((Number(m)-1)/3)+1}`;
      };
      const showTick = (d) => {
        switch(level){
          case 'weekly':   return parseISO(d).getDay() === 1; // ÏõîÏöîÏùº
          case 'biweekly': {
            const firstMonday = rawDates.find(dd => parseISO(dd).getDay() === 1);
            if (!firstMonday) return false;
            if (parseISO(d).getDay() !== 1) return false;
            const weeks = Math.round(diffDays(firstMonday, d)/7);
            return weeks % 2 === 0;
          }
          case 'monthly':   return isMonthStart(d);
          case 'quarterly': return isQuarterStart(d);
          default:          return true;
        }
      };

      const labels = rawDates;

      if (lineChart) lineChart.destroy();
      lineChart = new Chart($('#line').getContext('2d'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Total Value',
            data,
            tension: 0.3,
            fill: true,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { left: 0 } },
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: v => Math.round(v / 1_000_000), // Ï†ïÏàò MM
                precision: 0,
                maxTicksLimit: 6
              },
              grid: { drawBorder: false }
            },
            x: {
              ticks: {
                autoSkip: false,
                maxRotation: 0,
                minRotation: 0,
                callback: (_, index) => {
                  const d = labels[index];
                  return showTick(d) ? fmtLabel(d) : '';
                }
              }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: items => labels[items[0].dataIndex],
                label: c => ` ‚Ç©${Math.round(c.parsed.y / 1_000_000)} MM`
              }
            }
          }
        }
      });
    }

    // ===================== INTERACTION =====================
    function setPerson(personId) {
      TARGET_PERSON = personId;
      localStorage.setItem('targetPerson', personId);
      $('#person-select').value = personId;
      fetchDashboardData();
    }
    function setLanguage(lang) {
      CURRENT_LANG = lang;
      localStorage.setItem('dashboardLang', lang);
      applyTranslations(lang);
    }
    function enterFullscreen(){
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
    }
    function applyStoredTheme(){
      const stored = localStorage.getItem('theme-mode');
      if (stored === 'dark') document.documentElement.classList.add('dark');
    }
    function toggleTheme(){
      const html = document.documentElement;
      html.classList.toggle('dark');
      localStorage.setItem('theme-mode', html.classList.contains('dark') ? 'dark' : 'light');
    }
    function toggleSwitcher() {
      const button = $('#toggle-auto');
      if (switcherInterval) {
        clearInterval(switcherInterval);
        switcherInterval = null;
        button.textContent = TRANSLATIONS[CURRENT_LANG].autoOn;
        localStorage.setItem('autoSwitchEnabled', 'false');
      } else {
        switcherInterval = setInterval(() => {
          const currentIndex = PEOPLE_IDS.indexOf(TARGET_PERSON);
          const nextIndex = (currentIndex + 1) % PEOPLE_IDS.length;
          setPerson(PEOPLE_IDS[nextIndex]);
        }, 15000);
        button.textContent = TRANSLATIONS[CURRENT_LANG].autoOff;
        localStorage.setItem('autoSwitchEnabled', 'true');
      }
    }
    function populatePersonSelector() {
      const selector = $('#person-select');
      selector.innerHTML = '';
      for (const id of PEOPLE_IDS) {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = id.charAt(0).toUpperCase();
        selector.appendChild(option);
      }
      selector.value = TARGET_PERSON;
    }

    // ===================== INIT =====================
    window.addEventListener('load', () => {
      applyStoredTheme();
      const storedPerson = localStorage.getItem('targetPerson');
      if (storedPerson) TARGET_PERSON = storedPerson;
      else localStorage.setItem('targetPerson', TARGET_PERSON);

      const storedLang = localStorage.getItem('dashboardLang');
      if (storedLang) { CURRENT_LANG = storedLang; $('#lang-select').value = storedLang; }
      else { localStorage.setItem('dashboardLang', CURRENT_LANG); }

      const autoSwitchEnabled = localStorage.getItem('autoSwitchEnabled');
      if (autoSwitchEnabled === 'true') toggleSwitcher();

      populatePersonSelector();

      $('#toggleTheme').addEventListener('click', toggleTheme);
      $('#fullscreen-button').addEventListener('click', enterFullscreen);
      $('#person-select').addEventListener('change', (e) => setPerson(e.target.value));
      $('#lang-select').addEventListener('change', (e) => setLanguage(e.target.value));
      $('#toggle-auto').addEventListener('click', toggleSwitcher);

      applyTranslations(CURRENT_LANG);
      setInterval(fetchDashboardData, REFRESH_MS);
    });
  </script>
</body>
</html>
